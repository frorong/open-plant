<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Reference | Open Plant WSI Docs</title>
    <meta name="description" content="Open Plant WSI API reference" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/site.css" />
  </head>
  <body data-page="api-reference">
    <header class="topbar">
      <div class="topbar-inner">
        <a class="brand" href="index.html"><span class="brand-dot"></span><span>Open Plant WSI</span></a>
        <nav class="topnav" aria-label="Main Navigation">
          <a href="index.html" data-nav="index">Overview</a>
          <a href="getting-started.html" data-nav="getting-started">Getting Started</a>
          <a href="draw-and-roi.html" data-nav="draw-and-roi">ROI Draw</a>
          <a href="api-reference.html" data-nav="api-reference">API</a>
          <a href="migration-guide.html" data-nav="migration-guide">Migration</a>
          <a href="contributing.html" data-nav="contributing">Contributing</a>
          <a href="architecture.html" data-nav="architecture">Architecture</a>
          <a href="deploy-github-pages.html" data-nav="deploy-github-pages">Deploy</a>
          <a href="../ko/api-reference.html">KO</a>
        </nav>
      </div>
    </header>

    <main class="page">
      <div class="layout">
        <aside class="sidebar">
          <h2>API</h2>
          <a href="#wsi-viewer">WsiViewerCanvas</a>
          <a href="#draw-layer">DrawLayer</a>
          <a href="#tile-viewer">TileViewerCanvas</a>
          <a href="#types">Core types</a>
          <a href="#utils">Utilities</a>
          <a href="#api-stability">API Stability</a>
          <a href="migration-guide.html">Migration Guide</a>
        </aside>

        <article class="content">
          <section class="hero reveal">
            <div class="kicker">Reference</div>
            <h1>Public API Surface</h1>
            <p>All items below are exported from <code>src/index.ts</code>.</p>
          </section>

          <section class="panel reveal" id="wsi-viewer">
            <h2>`WsiViewerCanvas` props</h2>
            <table>
              <thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead>
              <tbody>
                <tr><td><code>source</code></td><td><code>WsiImageSource | null</code></td><td>Image source metadata.</td></tr>
                <tr><td><code>authToken</code></td><td><code>string</code></td><td>Authorization header token when required.</td></tr>
                <tr><td><code>viewState</code></td><td><code>Partial&lt;WsiViewState&gt;</code></td><td>Controlled zoom/offset/rotation state (<code>rotationDeg</code>).</td></tr>
                <tr><td><code>onViewStateChange</code></td><td><code>(next) =&gt; void</code></td><td>Camera state callback.</td></tr>
                <tr><td><code>imageColorSettings</code></td><td><code>WsiImageColorSettings | null</code></td><td>Tile-only brightness/contrast/saturation input (<code>[-100, 100]</code>). Point/ROI/draw overlay colors are unaffected.</td></tr>
                <tr><td><code>onStats</code></td><td><code>(stats: WsiRenderStats) =&gt; void</code></td><td>Per-frame observability event. Includes tile/point counters plus queue/failure/cache-hit metrics and frame time.</td></tr>
                <tr><td><code>onTileError</code></td><td><code>(event) =&gt; void</code></td><td>Tile load failure callback with tile info, error object, and retry attempt count.</td></tr>
                <tr><td><code>onContextLost</code></td><td><code>() =&gt; void</code></td><td>Called when WebGL context is lost and render loop is paused.</td></tr>
                <tr><td><code>onContextRestored</code></td><td><code>() =&gt; void</code></td><td>Called after renderer rebuilds GPU state on context restore.</td></tr>
                <tr><td><code>debugOverlay</code></td><td><code>boolean</code></td><td>Enables built-in runtime debug HUD overlay. Default: <code>false</code>.</td></tr>
                <tr><td><code>debugOverlayStyle</code></td><td><code>CSSProperties</code></td><td>Style override for the built-in debug HUD.</td></tr>
                <tr><td><code>fitNonce</code></td><td><code>number</code></td><td>Re-triggers fit-to-image when changed.</td></tr>
                <tr><td><code>rotationResetNonce</code></td><td><code>number</code></td><td>Calls rotation reset when changed.</td></tr>
                <tr><td><code>ctrlDragRotate</code></td><td><code>boolean</code></td><td>Enables <code>Ctrl/Cmd + drag</code> rotate interaction. Default: <code>true</code>.</td></tr>
                <tr><td><code>minZoom</code></td><td><code>number</code></td><td>Minimum zoom override. If omitted, renderer uses <code>fitZoom * 0.5</code>. Applied to wheel, double-click, <code>setViewState</code>, and <code>fitToImage</code>.</td></tr>
                <tr><td><code>maxZoom</code></td><td><code>number</code></td><td>Maximum zoom override. If omitted, renderer uses <code>fitZoom * 8</code>.</td></tr>
                <tr><td><code>viewTransition</code></td><td><code>{ duration?: number; easing?: (t) =&gt; number }</code></td><td>Default camera transition for view updates. Duration is clamped to <code>0..2000ms</code>.</td></tr>
                <tr><td><code>pointData</code></td><td><code>WsiPointData | null</code></td><td>Point position + palette index buffers (optional <code>ids</code> supported for point hit-test).</td></tr>
                <tr><td><code>pointPalette</code></td><td><code>Uint8Array | null</code></td><td>RGBA palette texture data.</td></tr>
                <tr><td><code>pointSizeByZoom</code></td><td><code>Record&lt;number, number&gt;</code></td><td>Custom point size(px) stops by continuous zoom level. Values between stops are linearly interpolated.</td></tr>
                <tr><td><code>pointStrokeScale</code></td><td><code>number</code></td><td>Point ring stroke thickness scale.</td></tr>
                <tr><td><code>roiRegions</code></td><td><code>WsiRegion[]</code></td><td>Persisted ROI list with labels.</td></tr>
                <tr><td><code>roiPolygons</code></td><td><code>DrawCoordinate[][]</code></td><td>Simplified polygon-only ROI input.</td></tr>
                <tr><td><code>clipPointsToRois</code></td><td><code>boolean</code></td><td>Render only points inside ROI polygons.</td></tr>
                <tr><td><code>clipMode</code></td><td><code>"sync" | "worker" | "hybrid-webgpu"</code></td><td>ROI clip execution mode. Default is <code>"worker"</code>.</td></tr>
                <tr><td><code>onClipStats</code></td><td><code>(event) =&gt; void</code></td><td>Clip timing/result callback: mode, duration, input/output count, WebGPU usage, and draw-bridge flag (<code>bridgedToDraw</code>).</td></tr>
                <tr><td><code>onRoiPointGroups</code></td><td><code>(stats) =&gt; void</code></td><td>ROI term count callback derived from current points + regions.</td></tr>
                <tr><td><code>roiPaletteIndexToTermId</code></td><td><code>ReadonlyMap&lt;number,string&gt; | string[]</code></td><td>Optional palette-index to term-id map used by ROI term group callback.</td></tr>
                <tr><td><code>interactionLock</code></td><td><code>boolean</code></td><td>Locks pan/zoom interactions.</td></tr>
                <tr><td><code>drawTool</code></td><td><code>"cursor" | "freehand" | "rectangle" | "circular" | "brush" | StampDrawTool</code></td><td>Active draw tool. <code>stamp-rectangle-4096px</code> emits patch intent. Brush emits <code>intent: "brush"</code> on completion.</td></tr>
                <tr><td><code>stampOptions</code></td><td><code>{ rectangleAreaMm2?: number; circleAreaMm2?: number; rectanglePixelSize?: number }</code></td><td>Stamp size configuration from outside the library. Defaults are 2mm² for area stamps and 4096px for fixed-pixel rectangle stamp.</td></tr>
                <tr><td><code>brushOptions</code></td><td><code>BrushOptions</code></td><td>Brush radius/detail/smoothing/cursor options. Radius is HTML/CSS px and stays zoom-invariant on screen.</td></tr>
                <tr><td><code>drawFillColor</code></td><td><code>string</code></td><td>Preview fill color for freehand/rectangle/circular while drawing. Default: <code>transparent</code>.</td></tr>
                <tr><td><code>patchRegions</code></td><td><code>WsiRegion[]</code></td><td>Patch-only persisted polygons rendered independently from ROI selection/hover state.</td></tr>
                <tr><td><code>patchStrokeStyle</code></td><td><code>Partial&lt;RegionStrokeStyle&gt;</code></td><td>Patch-only stroke style override (default: dashed cyan).</td></tr>
                <tr><td><code>regionStrokeStyle</code></td><td><code>Partial&lt;RegionStrokeStyle&gt;</code></td><td>Persisted region stroke override.</td></tr>
                <tr><td><code>regionStrokeHoverStyle</code></td><td><code>Partial&lt;RegionStrokeStyle&gt;</code></td><td>Stroke override while hovering a region.</td></tr>
                <tr><td><code>regionStrokeActiveStyle</code></td><td><code>Partial&lt;RegionStrokeStyle&gt;</code></td><td>Stroke override for active region (including shadow).</td></tr>
                <tr><td><code>resolveRegionStrokeStyle</code></td><td><code>(context) =&gt; Partial&lt;RegionStrokeStyle&gt;</code></td><td>Per-region/per-state dynamic stroke resolver.</td></tr>
                <tr><td><code>resolveRegionLabelStyle</code></td><td><code>(context) =&gt; Partial&lt;RegionLabelStyle&gt;</code></td><td>Per-region dynamic label style resolver (for zoom-aware <code>offsetY</code> etc).</td></tr>
                <tr><td><code>overlayShapes</code></td><td><code>DrawOverlayShape[]</code></td><td>Custom overlay shapes rendered by DrawLayer (supports polygon stroke and inverted-fill mask).</td></tr>
                <tr><td><code>customLayers</code></td><td><code>WsiCustomLayer[]</code></td><td>Custom React overlay layer slots with world/screen converters and redraw trigger.</td></tr>
                <tr><td><code>regionLabelStyle</code></td><td><code>Partial&lt;RegionLabelStyle&gt;</code></td><td>Persisted region label override.</td></tr>
                <tr><td><code>drawAreaTooltip</code></td><td><code>DrawAreaTooltipOptions</code></td><td>Realtime mm² tooltip during freehand/rectangle/circular drawing.</td></tr>
                <tr><td><code>autoLiftRegionLabelAtMaxZoom</code></td><td><code>boolean</code></td><td>When true, labels animate upward by 20px when view reaches <code>maxZoom</code> and animate back when leaving max zoom.</td></tr>
                <tr><td><code>onPointerWorldMove</code></td><td><code>(event) =&gt; void</code></td><td>World-coordinate pointer stream callback for custom coordinate HUD.</td></tr>
                <tr><td><code>onPointHover</code></td><td><code>(event) =&gt; void</code></td><td>Nearest point hover event in cursor mode. Emits <code>index/id</code> or <code>null</code> when no hit.</td></tr>
                <tr><td><code>onPointClick</code></td><td><code>(event) =&gt; void</code></td><td>Nearest point click event in cursor mode (left/right button info included).</td></tr>
                <tr><td><code>getCellByCoordinatesRef</code></td><td><code>MutableRefObject&lt;(coord) =&gt; PointHitEvent | null&gt;</code></td><td>Imperative world-coordinate point hit-test resolver.</td></tr>
                <tr><td><code>onRegionHover</code></td><td><code>(event) =&gt; void</code></td><td>Region hover event in cursor mode.</td></tr>
                <tr><td><code>onRegionClick</code></td><td><code>(event) =&gt; void</code></td><td>Region click event in cursor mode.</td></tr>
                <tr><td><code>activeRegionId</code></td><td><code>string | number | null</code></td><td>Controlled active region id. If omitted, component runs in uncontrolled mode.</td></tr>
                <tr><td><code>onActiveRegionChange</code></td><td><code>(regionId) =&gt; void</code></td><td>Active region changed event. Default behavior toggles off when clicking the same region, and clears on empty-space click.</td></tr>
                <tr><td><code>onDrawComplete</code></td><td><code>(result) =&gt; void</code></td><td>Draw completion callback payload with <code>intent: "roi" | "patch" | "brush"</code>.</td></tr>
                <tr><td><code>onPatchComplete</code></td><td><code>(result) =&gt; void</code></td><td>Patch-only callback, emitted for <code>stamp-rectangle-4096px</code>.</td></tr>
                <tr><td><code>overviewMapConfig</code></td><td><code>OverviewMapConfig</code></td><td>Overview map toggles/options/styles.</td></tr>
                <tr><td><code>className</code></td><td><code>string</code></td><td>Root container class name.</td></tr>
                <tr><td><code>style</code></td><td><code>CSSProperties</code></td><td>Root container style.</td></tr>
              </tbody>
            </table>
            <div class="callout">
              Region hit-test in cursor mode is constrained to contour + label area. Region interior fill is intentionally excluded.
            </div>
            <div class="callout">
              Tile color correction normalization: <code>brightness / 200</code>, <code>contrast / 100</code>, <code>saturation / 100</code>. It applies to tile shader only.
            </div>
          </section>

          <section class="panel reveal" id="draw-layer">
            <h2>`DrawLayer` and shape utilities</h2>
            <table>
              <thead><tr><th>Export</th><th>Description</th></tr></thead>
              <tbody>
                <tr><td><code>DrawLayer</code></td><td>Standalone draw overlay canvas component.</td></tr>
                <tr><td><code>closeRing(coords)</code></td><td>Closes polygon by repeating first coordinate at the end.</td></tr>
                <tr><td><code>createRectangle(start, end)</code></td><td>Generates closed rectangle coordinates.</td></tr>
                <tr><td><code>createCircle(start, end)</code></td><td>Generates circle polygon coordinates.</td></tr>
                <tr><td><code>DrawResult</code></td><td><code>{ tool, intent, coordinates, bbox, areaPx }</code> where <code>intent</code> is <code>"roi"</code>, <code>"patch"</code>, or <code>"brush"</code>.</td></tr>
                <tr><td><code>PatchDrawResult</code></td><td>Patch-specialized draw payload for <code>stamp-rectangle-4096px</code>.</td></tr>
                <tr><td><code>DrawRegion</code></td><td><code>{ id?, coordinates, label? }</code></td></tr>
                <tr><td><code>DrawIntent</code></td><td>Intent union used by draw completion (<code>"roi" | "patch" | "brush"</code>).</td></tr>
                <tr><td><code>DrawOverlayShape</code></td><td><code>{ id?, coordinates, closed?, fill?, stroke?, strokeStyle?, invertedFill?, visible? }</code> where <code>coordinates</code> accepts <code>DrawCoordinate[]</code>, <code>DrawCoordinate[][]</code>, or <code>DrawCoordinate[][][]</code> (single ring, multi-ring, or multi-polygon).</td></tr>
                <tr><td><code>DrawOverlayInvertedFillStyle</code></td><td><code>{ fillColor: string }</code> fill style for inverted mask outside polygons.</td></tr>
                <tr><td><code>BrushOptions</code></td><td>Brush radius/detail/smoothing/cursor config. <code>radius</code> is HTML/CSS px (screen-fixed), while output geometry is converted to world coordinates per zoom.</td></tr>
                <tr><td><code>RegionStyleContext</code></td><td>State payload for <code>resolveRegionStrokeStyle</code> (<code>default</code>/<code>hover</code>/<code>active</code>).</td></tr>
                <tr><td><code>RegionLabelStyleContext</code></td><td>Resolver context payload (<code>region</code>, <code>regionId</code>, <code>regionIndex</code>, <code>zoom</code>).</td></tr>
                <tr><td><code>RegionLabelStyleResolver</code></td><td>Dynamic label resolver used by <code>resolveRegionLabelStyle</code>.</td></tr>
                <tr><td><code>StampOptions</code></td><td>Stamp options for mm² and fixed pixel rectangle size.</td></tr>
                <tr><td><code>RegionStrokeStyle</code></td><td>Color/width/dash/cap/join + shadow (color/blur/offset) fields.</td></tr>
                <tr><td><code>RegionLabelStyle</code></td><td>Typography/background/padding/offset/border fields for persisted labels.</td></tr>
                <tr><td><code>DrawAreaTooltipOptions</code></td><td>Realtime area tooltip options (<code>enabled</code>, <code>format</code>, <code>style</code>, <code>cursorOffset</code>).</td></tr>
                <tr><td><code>DrawAreaTooltipStyle</code></td><td>Tooltip typography/background/padding style fields used during drawing.</td></tr>
              </tbody>
            </table>
          </section>

          <section class="panel reveal" id="tile-viewer">
            <h2>`TileViewerCanvas` props</h2>
            <table>
              <thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead>
              <tbody>
                <tr><td><code>imageWidth</code></td><td><code>number</code></td><td>Source image width in pixels.</td></tr>
                <tr><td><code>imageHeight</code></td><td><code>number</code></td><td>Source image height in pixels.</td></tr>
                <tr><td><code>tiles</code></td><td><code>TileDefinition[]</code></td><td>M1 tile definition list.</td></tr>
                <tr><td><code>viewState</code></td><td><code>Partial&lt;ViewState&gt;</code></td><td>Optional controlled camera state.</td></tr>
              </tbody>
            </table>
          </section>

          <section class="panel reveal" id="types">
            <h2>Core types</h2>
            <pre><code class="language-ts">interface WsiImageSource {
  id: string;
  name: string;
  width: number;
  height: number;
  mpp?: number;
  tileSize: number;
  maxTierZoom: number;
  tilePath: string;
  tileBaseUrl: string;
  terms: WsiTerm[];
  tileUrlBuilder?: (tier: number, x: number, y: number) => string;
}

interface WsiPointData {
  count: number;
  positions: Float32Array;
  paletteIndices: Uint16Array;
  fillModes?: Uint8Array; // optional fill mode per point (0: ring, 1: solid)
  ids?: Uint32Array; // optional point ids for hit-test/cell actions
  drawIndices?: Uint32Array; // optional draw bridge (subset indices)
}

interface WsiViewState {
  zoom: number;
  offsetX: number;
  offsetY: number;
  rotationDeg: number;
}

interface WsiRenderStats {
  tier: number;
  visible: number;
  rendered: number;
  fallback: number;
  points: number;
  cache: number;
  inflight: number;
  queued?: number;
  retries?: number;
  failed?: number;
  aborted?: number;
  cacheHits?: number;
  cacheMisses?: number;
  drawCalls?: number;
  frameMs?: number;
}</code></pre>
          </section>

          <section class="panel reveal" id="api-stability">
            <h2>API Stability Policy (WS-10)</h2>
            <div class="flow">
              <div class="flow-step"><strong>SemVer:</strong> patch = bug fixes, minor = backward-compatible additions, major = breaking changes.</div>
              <div class="flow-step"><strong>Deprecation lifecycle:</strong> add replacement first, mark deprecated in docs, keep compatibility for at least two minor releases, remove only in the next major.</div>
              <div class="flow-step"><strong>Migration contract:</strong> every breaking change must ship with before/after examples and a checklist.</div>
            </div>
            <div class="callout">
              Known limitations: browser-interaction E2E (real pan/zoom/draw automation) is not yet fully covered in CI.
            </div>
            <div class="callout">
              For upgrade steps and before/after snippets, see <a href="migration-guide.html">Migration Guide</a>.
            </div>
          </section>

          <section class="panel reveal" id="utils">
            <h2>Utility exports</h2>
            <table>
              <thead><tr><th>Function</th><th>Description</th></tr></thead>
              <tbody>
                <tr><td><code>normalizeImageInfo(raw, tileBaseUrl)</code></td><td>Converts backend payload + tile base URL to <code>WsiImageSource</code>.</td></tr>
                <tr><td><code>toTileUrl(source, tier, x, y)</code></td><td>Builds IMS tile URL.</td></tr>
                <tr><td><code>buildTermPalette(terms)</code></td><td>Builds termId to palette mapping and RGBA texture.</td></tr>
                <tr><td><code>filterPointDataByPolygons(data, polygons)</code></td><td>Filters points inside ROI polygons only.</td></tr>
                <tr><td><code>filterPointDataByPolygonsInWorker(data, polygons)</code></td><td>Runs ROI clipping in a dedicated worker thread.</td></tr>
                <tr><td><code>terminateRoiClipWorker()</code></td><td>Terminates the shared ROI clip worker instance (useful on teardown/tests).</td></tr>
                <tr><td><code>filterPointIndicesByPolygons(data, polygons)</code></td><td>Returns original point indices inside polygons for patch JSON export pipelines.</td></tr>
                <tr><td><code>filterPointIndicesByPolygonsInWorker(data, polygons)</code></td><td>Worker variant returning point indices + timing metadata.</td></tr>
                <tr><td><code>filterPointDataByPolygonsHybrid(data, polygons, options?)</code></td><td>Experimental hybrid clipping (WebGPU bbox prefilter + exact polygon test). Use <code>{ bridgeToDraw: true }</code> to return full buffers + <code>drawIndices</code> bridge payload.</td></tr>
                <tr><td><code>computeRoiPointGroups(pointData, regions, options)</code></td><td>Computes per-ROI term counts (<code>roiPointGroups</code>-style) from typed point buffers.</td></tr>
                <tr><td><code>getWebGpuCapabilities()</code></td><td>Returns WebGPU support/adapter/features for runtime decisions.</td></tr>
                <tr><td><code>prefilterPointsByBoundsWebGpu(positions, count, bounds)</code></td><td>Experimental compute pass to classify points by ROI bounding boxes.</td></tr>
                <tr><td><code>calcScaleResolution(imageMpp, imageZoom, currentZoom)</code></td><td>Returns microns-per-screen-pixel for the current zoom.</td></tr>
                <tr><td><code>calcScaleLength(imageMpp, imageZoom, currentZoom)</code></td><td>Formats a 100px scale-bar label in μm/mm.</td></tr>
                <tr><td><code>toBearerToken(token)</code></td><td>Normalizes token to <code>Bearer ...</code> format.</td></tr>
              </tbody>
            </table>
            <div class="callout">
              <strong>What is mpp?</strong> <code>mpp</code> means microns per pixel at native pyramid level
              (<code>maxTierZoom</code>). Stamp physical size depends on this value. If <code>mpp</code> is missing,
              the renderer falls back to <code>1μm/px</code> assumption, so physical size is only approximate.
            </div>
          </section>

          <p class="footer">Open Plant WSI Docs • <span data-role="year"></span></p>
        </article>
      </div>
    </main>

    <script src="../assets/site.js" defer></script>
  </body>
</html>
